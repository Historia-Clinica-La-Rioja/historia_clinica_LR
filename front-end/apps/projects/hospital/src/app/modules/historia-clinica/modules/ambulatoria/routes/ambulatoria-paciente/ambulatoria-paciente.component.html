<app-content width="full">
	<section id="title">
		<h2 class="page-title" [translate]="'ambulatoria.paciente.TITLE'"></h2>
	</section>

	<section id="content" fxLayout="column" fxLayoutGap="20px">
		<app-patient-card *ngIf="personPhoto" [patient]="patient" [personalAdditionalInformation]="personInformation"
						  [personPhoto]="personPhoto" [showAdditionalInformation]="true"
						  [internmentEpisodeProcess]="internmentEpisodeProcess"
						  [emergencyCareEpisodeInProgress]="emergencyCareEpisodeInProgress?.inProgress">
			<div info-content fxLayout="row" fxLayout.xs="column">
				<div fxLayout="row">
					<mat-divider *ngIf="bloodType" class="header-divider" [vertical]="true"></mat-divider>
					<div *ngIf="bloodType?.length" fxLayout="column" fxLayoutAlign="center center" fxLayoutGap="3px" >
							<span class="center-align">{{ 'ambulatoria.paciente.card.GROUP_AND_FACTOR' | translate }}</span>
							<span class="center-align">{{ 'ambulatoria.paciente.card.SANGUINEOUS' | translate }}</span>
							<h1 class="color-primary bold" id="blood-type">{{ bloodType }}</h1>
					</div>
					<mat-divider class="header-divider" [vertical]="true"></mat-divider>
					<div id="allergy-container" fxLayout="row" fxLayoutAlign="center center">
						<div *ngIf="criticalAllergies?.length>0">
							<div fxLayout="row" *ngFor="let allergy of criticalAllergies.slice(0,limitAllergies)">
								<div fxLayout="column">
									<mat-icon class="color-warn allergy-icon" fontSet="material-icons-outlined">block</mat-icon>
								</div>
								<div fxLayout="column">
									<div fxLayout="row">
										<span class="allergy-item capitalize-first-letter">{{allergy.snomed.pt}}</span>
									</div>
								</div>
							</div>
							<div *ngIf="criticalAllergies?.length>limitAllergies">
								<button class="allergies-button" (click)="openAllergies()" mat-button type="button" color="primary">
							<span [translate]="'ambulatoria.paciente.card.MORE_CRITICAL_ALLERGIES'"
							[translateParams]="{allergies: criticalAllergies?.length-limitAllergies}"></span>
								</button>
							</div>
						</div>
						<div *ngIf="criticalAllergies?.length==0">
							<div fxLayout="row">
								<div fxLayout="column">
									<mat-icon class="color-disabled allergy-icon" fontSet="material-icons-outlined">block</mat-icon>
								</div>
								<div fxLayout="column">
									<div fxLayout="row">
										<span class="color-disabled">{{ 'ambulatoria.paciente.card.NO_CRITICAL_ALLERGIES' | translate}}</span>
									</div>
								</div>
							</div>
						</div>
					</div>
					<mat-divider class="header-divider" [vertical]="true"></mat-divider>
				</div>
					<div *ngIf="internmentEpisodeProcess?.id && internmentEpisodeProcess?.inProgress" id="coverage-container">
						<div fxLayout="row">
							<div fxLayout="column">
								<mat-icon class="color-primary" fontSet="material-icons-outlined">health_and_safety</mat-icon>
							</div>
							<div fxLayout="column">
								<div fxLayout="row" id="coverage-title">
									<span class="color-primary bold">{{ 'ambulatoria.paciente.card.internment.COVERAGE_TITLE' | translate }}</span>
								</div>
								<ng-container *ngIf="internmentEpisodeCoverageInfo">
									<div fxLayout="row">
										<span class="bold"> {{ internmentEpisodeCoverageInfo?.medicalCoverage?.name }}</span>
									</div>
									<div fxLayout="row">
										<span> {{ internmentEpisodeCoverageInfo?.medicalCoverage?.plan }}</span>
									</div>
									<div fxLayout="row">
										<span> {{ 'ambulatoria.paciente.card.internment.AFFILIATE_NUMBER' | translate }}
											<ng-container *ngIf="!internmentEpisodeCoverageInfo?.affiliateNumber">
												<span class="no-information">{{ 'ambulatoria.paciente.card.internment.NO_INFO' | translate }}</span>
											</ng-container>
											<ng-container *ngIf="internmentEpisodeCoverageInfo?.affiliateNumber">
												<span>{{ internmentEpisodeCoverageInfo?.affiliateNumber }}</span>
											</ng-container>
										</span>
									</div>
								</ng-container>
								<ng-container *ngIf="!internmentEpisodeCoverageInfo">
									<div fxLayout="row" class="no-information">
										<span>{{ 'ambulatoria.paciente.card.internment.WITHOUT_COVERAGE' | translate }}</span>
									</div>
								</ng-container>
							</div>
						</div>
					</div>
			</div>
			<div buttons-content>
				<div fxLayout="row" fxLayout.gt-xs="column" fxLayoutGap="10px">
					<ng-container *ngIf="hasNewConsultationEnabled$ | async">
						<ng-container
							*ngIf="CurrentUserIsAllowedToMakeBothQueries; else currentUserIsNotAllowedToMakeBothQueries">
							<button id="nueva_consulta" mat-flat-button color="primary" mat-button
								[matMenuTriggerFor]="menu">
								{{ 'ambulatoria.paciente.card.buttons.NUEVA_CONSULTA' | translate | uppercase }}</button>
							<mat-menu #menu="matMenu">
								<button mat-menu-item
									(click)="referenceNotificationService.hasReferenceNotification()">Ambulatoria</button>
								<button mat-menu-item (click)="openNuevaConsultaEnfermeria()">Enfermeria</button>
							</mat-menu>
						</ng-container>
						<div fxLayout="end" fxLayoutAlign="end">
							<button mat-stroked-button color="primary" (click)="goToPatient()" btn-block>{{
								'ambulatoria.paciente.card.buttons.SHOW_PATIENT' | translate | uppercase }}</button>
						</div>
					</ng-container>
				</div>
			</div>
		</app-patient-card>


		<div class="flex-container" *ngIf="externalInstitutionsEnabled">
			<div fxLayout="row" fxLayout.lt-md="column" fxLayoutAlign="center baseline"
				fxLayoutAlign.lt-md="baseline end">
				<div fxFlex="55%"></div>

				<div fxLayout="column" fxFlex="15%">
					<h5 class=uppercase [translate]="'ambulatoria.historia-clinica-externa.TITLE'"></h5>
				</div>
				<div fxLayout="column" fxFlex="25%">
					<mat-form-field>
						<mat-select [disabled]="!this.loaded" id="externalInstitutionId" name="externalInstitutionId"
							(click)="this.externalInstitutionsClicked()"
							[placeholder]="this.externalInstitutionPlaceholder">
							<mat-option *ngFor="let externalInstitution of this.externalInstitutions"
								[value]="externalInstitution.name"
								(click)="this.loadExternalSummary(externalInstitution)">
								{{externalInstitution.name}}
							</mat-option>
						</mat-select>
					</mat-form-field>
				</div>
				<div class="spinner" *ngIf="spinner" fxFlex="5%" fxLayoutGap="7px" fxLayoutAlign="baseline end">
					<mat-spinner color="primary" diameter="20"></mat-spinner>
				</div>
			</div>
		</div>

		<mat-card id="tab_container" class="mat-typography">
			<mat-card-content>
				<mat-tab-group (selectedTabChange)="onTabChanged($event)" *ngIf="hasInternmentEpisodeInThisInstitution !== undefined">
					<mat-tab id="tab_resumen" *ngIf="!hasInternmentEpisodeInThisInstitution">
						<ng-template mat-tab-label>
							<span>{{ 'ambulatoria.paciente.resumen.TAB_LABEL' | translate | uppercase }}</span>
						</ng-template>
						<ng-template matTabContent>
							<app-resumen [patientExternalSummary]="patientExternalSummary"></app-resumen>
						</ng-template>
					</mat-tab>
					<mat-tab id="tab_internacion" *ngIf="hasInternmentEpisodeInThisInstitution">
						<ng-template mat-tab-label>
							<span>{{ 'ambulatoria.paciente.internacion.TAB_LABEL' | translate | uppercase }}</span>
						</ng-template>
						<ng-template matTabContent>
							<app-internacion-paciente [internmentEpisodeId]="internmentEpisodeProcess.id"></app-internacion-paciente>
						</ng-template>
					</mat-tab>
					<mat-tab id="tab_indications">
						<ng-template mat-tab-label>
							<span>{{ 'ambulatoria.paciente.indications.TAB_LABEL' | translate | uppercase }}</span>
						</ng-template>
						<ng-template matTabContent>
							<app-card-medicaciones [patientId]="patientId" [medicamentStatus]="medicamentStatus$ | async" ></app-card-medicaciones>
						</ng-template>
					</mat-tab>
					<mat-tab id="tab_studies">
						<ng-template mat-tab-label>
							<span>{{ 'ambulatoria.paciente.studies.TAB_LABEL' | translate | uppercase }}</span>
						</ng-template>
						<ng-template matTabContent>
							<app-card-estudios [patientId]="patientId" [diagnosticReportsStatus]="diagnosticReportsStatus$ | async" [categories]="studyCategories$ | async"></app-card-estudios>
							<app-card-indicaciones [patientId]="patientId" *ngIf="false"></app-card-indicaciones>
						</ng-template>
					</mat-tab>
					<mat-tab id="tab_vacunas">
						<ng-template mat-tab-label>
							<span>{{ 'ambulatoria.paciente.vacunas.TAB_LABEL' | translate | uppercase }}</span>
						</ng-template>
						<ng-template matTabContent>
							<app-vacunas></app-vacunas>
						</ng-template>
					</mat-tab>
					<mat-tab id="tab_problemas">
						<ng-template mat-tab-label>
							<span>{{ 'ambulatoria.paciente.problemas.TAB_LABEL' | translate | uppercase }}</span>
						</ng-template>
						<ng-template matTabContent>
							<app-problemas [nuevaConsultaRef]="dialogRef"></app-problemas>
						</ng-template>
					</mat-tab>
					<mat-tab *ngFor="let extensionTab of extensionTabs$ | async" [id]="extensionTab.head.id">
						<ng-template mat-tab-label>
							<mat-icon>{{extensionTab.head.icon}}</mat-icon>
							<app-label [label]="extensionTab.head.label"></app-label>
						</ng-template>
						<ng-template matTabContent>
							<ng-container *ngIf="(extensionTab.body$ | async) as tabPage; else loading">
								<app-page-layout [page]="tabPage"></app-page-layout>
							</ng-container>
						</ng-template>
					</mat-tab>
					<mat-tab id="tab_odontologia" *ngIf="odontologyEnabled">
						<ng-template mat-tab-label>
							<span>ODONTOLOG√çA</span>
						</ng-template>
						<ng-template matTabContent>
							<app-odontogram (isOpenOdontologyConsultation)="setStateConsultationOdontology($event)"
								(consultationCompleted)="updateFields($event)"></app-odontogram>
						</ng-template>
					</mat-tab>

				</mat-tab-group>
			</mat-card-content>
		</mat-card>
	</section>

</app-content>

<ng-template #loading>
	<mat-progress-bar mode="indeterminate"></mat-progress-bar>
</ng-template>

<ng-template #currentUserIsNotAllowedToMakeBothQueries>
	<button *appHasRole="['ESPECIALISTA_MEDICO', 'PROFESIONAL_DE_SALUD']" id="nueva_consulta" mat-flat-button
		color="primary" mat-button (click)="referenceNotificationService.hasReferenceNotification()">
		{{ 'ambulatoria.paciente.card.buttons.NUEVA_CONSULTA' | translate | uppercase }}</button>

	<button *appHasRole="['ENFERMERO']" id="nueva_consulta" mat-flat-button color="primary" mat-button
		(click)="openNuevaConsultaEnfermeria()">
		{{ 'ambulatoria.paciente.card.buttons.NUEVA_CONSULTA' | translate | uppercase }}</button>
</ng-template>
