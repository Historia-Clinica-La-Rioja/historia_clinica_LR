<div fxLayout="row" fxLayoutAlign="space-between start">
    <h1 mat-dialog-title>{{ data.titleLabel | translate}}</h1>
    <button id="close-modal" mat-button mat-icon-button aria-label="close" [matDialogClose]="false">
        <mat-icon>close</mat-icon>
    </button>
</div>

<div mat-dialog-content>
	<app-concepts-search *ngIf="conceptsView else PrescriptionItemForm"
		[initialSearchValue]="this.snomedConcept"
		[label]="data.searchSnomedLabel"
		(search)="onSearch($event)">
	</app-concepts-search>

	<div class="spinner" *ngIf="searching && !snowstormServiceNotAvailable">
		<mat-spinner diameter="70" color="primary"></mat-spinner>
	</div>

	<div *ngIf="snowstormServiceNotAvailable">
		<div style="padding-bottom: 1em">
			<span style="font-weight: bold; padding-bottom: 2em" [translate]="'historia-clinica.snowstorm.ERROR_MESSAGE_DESCRIPTION'"></span>: {{snowstormServiceErrorMessage}}
		</div>
		<span [translate]="'historia-clinica.snowstorm.SERVICE_NOT_AVAILABLE'"> </span>
	</div>

	<app-table *ngIf="!searching && conceptsView" [model]="conceptsResultsTable"
		[mainStyle]="'secondary'"></app-table>

	<ng-template #PrescriptionItemForm>
		<form [formGroup]="prescriptionItemForm" fxLayout="column" fxLayoutGap="15px" (ngSubmit)="addPrescriptionItem()">
			<mat-form-field appearance="outline" (keyup.enter)="toggleConceptsView(snomed.value)">
				<mat-label class="capitalize-first-letter">{{data.searchSnomedLabel | translate}}</mat-label>
				<input matInput type="text" formControlName="snomed" name="snomed" #snomed>
				<button mat-button matSuffix color="primary" mat-icon-button (click)="toggleConceptsView(snomed.value)">
					<mat-icon>search</mat-icon>
				</button>
				<mat-hint>{{'ambulatoria.paciente.ordenes_prescripciones.add_prescription_item_dialog.ADD_CHARACTERS' | translate}}</mat-hint>
			</mat-form-field>
	
			<section class="dose-data">
				<mat-form-field appearance="outline">
					<mat-label>{{'ambulatoria.paciente.ordenes_prescripciones.add_prescription_item_dialog.UNIT_DOSE' | translate}}</mat-label>
					<input type="number" matInput autocomplete="off" formControlName="unitDose">
					<mat-error *ngIf="hasError(prescriptionItemForm, 'required', 'unitDose')" translate="forms.REQUIRED"></mat-error>
				</mat-form-field>
		
				<mat-form-field appearance="outline">
					<mat-label>{{'ambulatoria.paciente.ordenes_prescripciones.add_prescription_item_dialog.DAY_DOSE' | translate}}</mat-label>
					<input type="number" matInput autocomplete="off" formControlName="dayDose">
					<mat-error *ngIf="hasError(prescriptionItemForm, 'required', 'dayDose')" translate="forms.REQUIRED"></mat-error>
				</mat-form-field>
		
				<mat-form-field appearance="outline">
					<mat-label>{{'ambulatoria.paciente.ordenes_prescripciones.add_prescription_item_dialog.TREATMENT_DAYS' | translate}}</mat-label>
					<input type="number" matInput autocomplete="off" formControlName="treatmentDays">
					<mat-error *ngIf="hasError(prescriptionItemForm, 'required', 'treatmentDays')" translate="forms.REQUIRED"></mat-error>
				</mat-form-field>
			</section>
	
			<mat-form-field appearance="outline">
				<mat-label>{{'ambulatoria.paciente.ordenes_prescripciones.add_prescription_item_dialog.ASSOCIATED_PROBLEM' | translate}}</mat-label>
				<mat-select formControlName="healthProblem" name="healthProblem">
					<mat-option *ngFor="let healthProblem of healthProblemOptions" [value]="healthProblem.sctId">
						{{healthProblem.description | translate}}
					</mat-option>
					<mat-option (click)="addNewProblem()">
						<button mat-button type="button" color="primary">
							{{'ambulatoria.paciente.ordenes_prescripciones.add_prescription_item_dialog.ADD_NEW_PROBLEM' | translate }}
						</button>
					</mat-option>
				</mat-select>
				<mat-error *ngIf="hasError(prescriptionItemForm, 'required', 'healthProblem')" translate="forms.REQUIRED"></mat-error>
			</mat-form-field>
	
			<mat-form-field appearance="outline">
				<mat-label>{{'ambulatoria.paciente.ordenes_prescripciones.add_prescription_item_dialog.POSTADATA' | translate}}</mat-label>
				<input type="number" matInput autocomplete="off" formControlName="postadata">
				<mat-error *ngIf="hasError(prescriptionItemForm, 'required', 'postadata')" translate="forms.REQUIRED"></mat-error>
			</mat-form-field>
	
			<mat-form-field appearance="outline" *ngIf="data.showStudyCategory">
				<mat-label>{{'ambulatoria.paciente.ordenes_prescripciones.add_prescription_item_dialog.STUDY_CATEGORY' | translate}}</mat-label>
				<mat-select formControlName="studyCategory" name="studyCategory">
					<mat-option *ngFor="let studyCategory of studyCategoryOptions" [value]="studyCategory.id">
						{{studyCategory.description | translate}}
					</mat-option>
				</mat-select>
			</mat-form-field>
	
			<div class="mat-form-field-wrapper" fxLayout="column" fxLayout.gt-md="row" fxLayoutGap="50px" *ngIf="data.showDosage">
				<div fxLayout="column" fxLayoutGap="10px">
					<mat-label class="mat-subheading-2">{{'ambulatoria.paciente.ordenes_prescripciones.add_prescription_item_dialog.INTERVAL' | translate}}</mat-label>
					<mat-radio-group formControlName="interval" fxLayout="column" fxLayoutGap="10px">
						<mat-radio-button color="primary" [value]="DEFAULT_RADIO_OPTION">
							{{'ambulatoria.paciente.ordenes_prescripciones.add_prescription_item_dialog.INTERVAL_DEFAULT_OPTION' | translate}}
						</mat-radio-button>
						<mat-radio-button color="primary" [value]="OTHER_RADIO_OPTION">
							Cada <input #intervalHoursInput [style.width.ch]="getInputNumberWidth('intervalHours')"
									formControlName="intervalHours" type="number" matInput> hs.
							<mat-error *ngIf="intervalValidation(prescriptionItemForm, 'intervalHours', 'interval')">
								<span translate="ambulatoria.paciente.ordenes_prescripciones.add_prescription_item_dialog.INTERVAL_HOURS_REQUIRED"></span>
							</mat-error>
						</mat-radio-button>
					</mat-radio-group>
				</div>
			</div>
	
			<mat-form-field appearance="outline">
				<mat-label>{{'ambulatoria.paciente.ordenes_prescripciones.add_prescription_item_dialog.OBSERVATIONS' | translate}}</mat-label>
				<textarea matInput type="text" id="observations" name="observations"
							formControlName="observations"
							placeholder="{{'ambulatoria.paciente.ordenes_prescripciones.add_prescription_item_dialog.OBSERVATIONS' | translate }}">
				</textarea>
				<mat-error *ngIf="hasError(prescriptionItemForm, 'maxlength', 'observations')" translate="forms.MAX_LENGTH_ERROR"
							[translateParams]="{max: TEXT_AREA_MAX_LENGTH}">
				</mat-error>
	
			</mat-form-field>
	
			<div fxLayout="row" fxLayoutAlign="end start">
				<button mat-flat-button color="primary" type="submit" fxFlexFill.xs [disabled]=" ! this.prescriptionItemForm.valid">
					<span class="uppercase">{{'buttons.ADD' | translate}}</span>
				</button>
			</div>
	
		</form>
	</ng-template>
</div>