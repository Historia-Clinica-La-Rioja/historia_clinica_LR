<app-content>

	<h1>{{ 'guardia.episode.medical_discharge.TITLE' | translate}}</h1>
	<form [formGroup]="form" (submit)="confirm()">

		<div fxLayout="row" fxLayoutGap="5px" formGroupName="dateTime">
			<app-datepicker [title]="'guardia.episode.medical_discharge.form.DATE' | translate" id="date" [minDate]="episodeCreatedOn"
				[maxDate]="today" [dateToSetInDatepicker]="today" (selectDate)="dischargedDateChanged($event)">
			</app-datepicker>

			<div appearance="outline">
				<app-time-picker id="time" [timePickerData]="timePickerData" (timeSelected)="dischargedTimeChanged($event)"></app-time-picker>
				<mat-error *ngIf="hasError(form.get('dateTime'), 'required', 'time')" translate="forms.REQUIRED">
				</mat-error>
				<mat-error *ngIf="hasError(form.get('dateTime'), 'futureTime', 'time')"
					translate="forms.MAX_TIME_ERROR"></mat-error>
				<mat-error *ngIf="hasError(form.get('dateTime'), 'beforeTime', 'time')"
					translate="guardia.episode.medical_discharge.form.INVALID_TIME">
				</mat-error>
			</div>
		</div>

		<div id="problemas" style="padding-bottom: 15px">
				<strong><mat-label style= 'margin-top: 15px;' translate="guardia.episode.medical_discharge.problems.TITLE"></mat-label></strong>
				<div *ngFor="let problem of problems$ | async">
					<mat-checkbox [checked]="selectedProblems.has(problem.id)" [disabled]="checkIfShouldDisable(problem)" (change)="toggleSelection(problem)">
						{{ problem.snomed.pt }} |
						{{ problem.presuntive ? ("guardia.episode.medical_discharge.problems.PRESUNTIVE" | translate) : ("guardia.episode.medical_discharge.problems.CONFIRMED" | translate) }}
						{{ problem.main ? ("guardia.episode.medical_discharge.problems.MAIN" | translate) : "" }}
					</mat-checkbox>
				</div>

				<ng-template #problemaForm>
					<form [formGroup]="problemasService.getForm()" (ngSubmit)="problemasService.addToList()"
						fxLayout="column">

						<mat-form-field appearance="outline">
							<mat-label translate="guardia.episode.medical_discharge.problems.CONCEPT_LABEL">
							</mat-label>
							<input id="snomed-input" matInput type="text" formControlName="snomed" name="snomed"
								readonly matTooltip="{{ problemasService.getSnomedConcept().pt }}">
							<button id="clear"  matSuffix color="warn" mat-icon-button
								(click)="problemasService.resetForm()">
								<mat-icon>close</mat-icon>
							</button>
						</mat-form-field>

						<mat-form-field appearance="outline">
							<mat-label [translate]="'ambulatoria.paciente.nueva-consulta.problemas.SEVERIDAD'">
							</mat-label>
							<mat-select id="severity-select" formControlName="severidad">
								<mat-option *ngFor="let severityType of severityTypes" [value]="severityType.code">
									{{severityType.display}}
								</mat-option>
							</mat-select>
							<mat-error translate="forms.REQUIRED"></mat-error>
						</mat-form-field>

						<mat-checkbox id="cronico-checkbox" formControlName="cronico">
							<span translate="guardia.episode.medical_discharge.problems.CRONICO"></span>
						</mat-checkbox>

						<div fxLayout="row">

							<app-datepicker id="fecha_inicio"
								title="guardia.episode.medical_discharge.problems.FECHA_INICIO"
								[minDate]="minDate" [maxDate]="problemasService.getFechaInicioMax()" [dateToSetInDatepicker]="today"
								(selectDate)="problemStartDateChanged($event)">
							</app-datepicker>

							<app-datepicker id="fecha_fin" title="guardia.episode.medical_discharge.problems.FECHA_FIN" [minDate]="problemasService.getForm().controls.fechaInicio.value"
								[maxDate]="today" (selectDate)="problemEndDateChanged($event)">
							</app-datepicker>
						</div>

						<div align="end">
							<button id="submit_problema" class="uppercase" mat-raised-button color="primary"
								type="submit">
								<span translate="guardia.episode.medical_discharge.problems.buttons.ADD"></span>
							</button>
						</div>

					</form>
				</ng-template>

				<app-document-section-table data-display
					tableTitle="guardia.episode.medical_discharge.problems.TABLE_TITLE"
					[columns]="problemasService.getColumns()" [data]="problemasService.getProblemas()">
				</app-document-section-table>
			</app-new-document-section>
		</div>

		<div fxLayout="column">
			<strong><mat-label style= 'margin-top: 15px;' translate="guardia.episode.medical_discharge.form.DISCHARGE_TYPE"></mat-label></strong>
			<div style="display: flex; flex-wrap: wrap; gap: 12px;">
				<mat-radio-group formControlName="dischargeTypeId" name="dischargeTypeId">
					<div *ngFor="let dischargeType of (dischargeTypes$ | async)">
					<mat-radio-button [value]="dischargeType.id">
						{{ dischargeType.description }}
					</mat-radio-button>
					</div>
				</mat-radio-group>
			</div>

			<div *ngIf="form.get('dischargeTypeId').value == dischargeTypesEnum.DEFUNCION">
				<div fxLayout="column" fxLayoutGap="8px">
					<strong><mat-label translate="guardia.episode.medical_discharge.form.AUTOPSY"></mat-label></strong>
					<mat-form-field appearance="outline">
						<mat-select formControlName="autopsy" placeholder="{{'guardia.episode.medical_discharge.form.SELECT_AUTOPSY' | translate }}">
							<mat-option [value]="true">
								<span translate="forms.YES"></span>
							</mat-option>
							<mat-option [value]="false">
								<span translate="forms.NO"></span>
							</mat-option>
						</mat-select>
						<mat-error *ngIf="form.get('autopsy').hasError('required')"
							translate="forms.REQUIRED"></mat-error>
					</mat-form-field>
				</div>
			  </div>

			<div *ngIf="form.get('dischargeTypeId').value == dischargeTypesEnum.OTRO">
				<mat-form-field appearance="outline">
					<textarea formControlName="otherDischargeDescription"
						placeholder="{{'guardia.episode.medical_discharge.form.DISCHARGE_TYPE_INPUT' | translate }}"
						rows="4" matInput type="text">
               		 </textarea>
					<mat-error *ngIf="form.get('otherDischargeDescription').hasError('required')"
						translate="forms.REQUIRED"></mat-error>
				</mat-form-field>
			</div>
		</div>

		<div fxLayoutGap="10px" fxLayout="row" fxLayoutAlign="flex-end" style="margin-top: 5px;">
			<button mat-stroked-button class="uppercase" type="button" (click)="goToEpisodeDetails()">
				<span translate="buttons.BACK"></span>
			</button>
			<button mat-raised-button [disabled]="isLoading" class="uppercase" color="primary">
				<span translate="buttons.CONFIRM"></span>
			</button>
		</div>
	</form>

</app-content>
