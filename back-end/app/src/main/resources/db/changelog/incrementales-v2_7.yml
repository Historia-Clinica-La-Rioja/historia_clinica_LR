databaseChangeLog: 
    - logicalFilePath: incrementales-v2_7

    - changeSet:
        id: delete-repeted-clinical_specialty_mandatory_medical_practice-data
        comment: Eliminar registros repetidos en la tabla clinical_specialty_mandatory_medical_practice
        author: mvenere
        context: "!schema-only"
        changes:
          - sql:
              endDelimiter: ;;
              sql: |-
                CREATE TEMP TABLE id_mapping (old_id INT, new_id INT);
                WITH duplicate_rows AS (
                    SELECT
                        array_agg(id) AS ids,
                        clinical_specialty_id,
                        mandatory_medical_practice_id
                    FROM clinical_specialty_mandatory_medical_practice
                    GROUP BY clinical_specialty_id, mandatory_medical_practice_id
                    HAVING COUNT(*) > 1
                )
                INSERT INTO id_mapping (old_id, new_id)
                SELECT unnest(array_remove(d.ids, d.ids[1])), d.ids[1]
                FROM duplicate_rows d;
                UPDATE mandatory_professional_practice_free_days mppfd
                SET clinical_specialty_mandatory_medical_practice_id = m.new_id
                FROM id_mapping m
                WHERE mppfd.clinical_specialty_mandatory_medical_practice_id = m.old_id;
                UPDATE health_insurance_practice hip
                SET clinical_specialty_mandatory_medical_practice_id = m.new_id
                FROM id_mapping m
                WHERE hip.clinical_specialty_mandatory_medical_practice_id = m.old_id;
                DELETE FROM clinical_specialty_mandatory_medical_practice c
                WHERE id IN (SELECT old_id FROM id_mapping);
                DROP TABLE id_mapping;

    - changeSet:
        id: clinical_specialty_mandatory_medical_practice-unique_constraint
        author: mvenere
        changes:
          - addUniqueConstraint:
              tableName: clinical_specialty_mandatory_medical_practice
              columnNames: clinical_specialty_id, mandatory_medical_practice_id
              constraintName: UQ_clinical_specialty_id_mandatory_medical_practice_id
        
    - changeSet:    
        id: add-virtual-consultation-columns-diary_opening_hours
        author: mmalyvarni
        comment: add virtual consultation columns to diary_opening_hours table
        changes:
          - addColumn:
              tableName: diary_opening_hours
              columns:
                - column:
                    name: on_site_attention_allowed
                    type: boolean
                    defaultValue: ${boolean.true}
                - column:
                    name: patient_virtual_attention_allowed
                    type: boolean
                    defaultValue: ${boolean.false}
                - column:
                    name: second_opinion_virtual_attention_allowed
                    type: boolean
                    defaultValue: ${boolean.false}

    - changeSet:
        id: addNotNullConstraint-modalities-diary_opening_hours
        author: mmalyvarni
        changes:
          - addNotNullConstraint:
              columnDataType: boolean
              columnName: on_site_attention_allowed
              tableName: diary_opening_hours
              validate: true
          - addNotNullConstraint:
              columnDataType: boolean
              columnName: patient_virtual_attention_allowed
              tableName: diary_opening_hours
              validate: true
          - addNotNullConstraint:
              columnDataType: boolean
              columnName: second_opinion_virtual_attention_allowed
              tableName: diary_opening_hours
              validate: true