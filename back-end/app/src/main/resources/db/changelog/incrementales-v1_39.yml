databaseChangeLog: 
    - logicalFilePath: incrementales-v1_39

    - changeSet:
        id: document_appointment-createTable
        comment: Create table document_appointment
        author: tcepeda
        changes:
          - createTable:
              tableName: document_appointment
              columns:
                - column:
                    constraints:
                      nullable: false
                    name: document_id
                    type: bigint
                - column:
                    constraints:
                      nullable: false
                    name: appointment_id
                    type: int

          - addPrimaryKey:
              clustered: true
              columnNames: document_id, appointment_id
              constraintName: PK_document_appointment
              tableName: document_appointment
              validate: true

          - addForeignKeyConstraint:
              baseColumnNames: document_id
              baseTableName: document_appointment
              constraintName: FK_document_appointment_document_id
              onDelete: NO ACTION
              onUpdate: NO ACTION
              referencedColumnNames: id
              referencedTableName: document
              validate: true

          - addForeignKeyConstraint:
              baseColumnNames: appointment_id
              baseTableName: document_appointment
              constraintName: FK_document_appointment_appointment_id
              onDelete: NO ACTION
              onUpdate: NO ACTION
              referencedColumnNames: id
              referencedTableName: appointment
              validate: true

    - changeSet:
        id: fix-internment-episode-status-administrative-discharge-date-null-1.39
        comment: Corrige bug sobre el estado de internaci√≥n cuando no se tiene alta adminsitrativa.
        author: etrapani
        context: "!schema-only"
        changes:
          - sql:
              sql: |-
                UPDATE internment_episode
                SET status_id = 1
                WHERE id IN (
                  SELECT id
                  FROM internment_episode AS ie
                  LEFT join patient_discharge As pd ON (ie.id = pd.internment_episode_id)
                  WHERE ie.status_id = 2
                  AND pd.administrative_discharge_date is null)
        
    - changeSet:    
        id: add_clinical_specialty_id_diary
        comment: Agraga a las agendas una especialidad
        author: mmalyvarni
        changes:
          - addColumn:
              tableName: diary
              columns:
                - column:
                    constraints:
                      foreignKeyName: FK_diary_clinical_specialty_id
                      references: clinical_specialty(id)
                    name: clinical_specialty_id
                    type: int

    - changeSet:
        id: set_clinical_specialty_id_on_existing_diaries
        comment: Establece la especialidad de agendas ya existentes
        author: mmalyvarni
        context: "!schema-only"
        changes:
          - sql: |-
              UPDATE diary SET clinical_specialty_id = css.clinical_specialty_id 
              FROM doctors_office doff
              JOIN clinical_specialty_sector css 
              ON doff.clinical_specialty_sector_id = css.id
              WHERE doctors_office_id = doff.id
    
    - changeSet:
        id: dropNotNullConstraint-bed_category_id
        author: mvenere
        changes:
          - dropNotNullConstraint:
              columnDataType: smallint
              columnName: bed_category_id
              tableName: bed
              validate: true

    - changeSet:
        id: create-root-sector-view
        comment: Crea la vista RootSector para aquellos sectores sin padre
        author: mmalyvarni
        changes:
          - createView:
              - viewName: v_root_sector
              - fullDefinition: false
              - selectQuery: |-
                  (SELECT *
                   FROM sector AS s
                   WHERE s.sector_id IS NULL)
