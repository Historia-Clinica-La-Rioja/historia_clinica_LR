databaseChangeLog: 
    - logicalFilePath: incrementales-v1_39

    - changeSet:
        id: document_appointment-createTable
        comment: Create table document_appointment
        author: tcepeda
        changes:
          - createTable:
              tableName: document_appointment
              columns:
                - column:
                    constraints:
                      nullable: false
                    name: document_id
                    type: bigint
                - column:
                    constraints:
                      nullable: false
                    name: appointment_id
                    type: int

          - addPrimaryKey:
              clustered: true
              columnNames: document_id, appointment_id
              constraintName: PK_document_appointment
              tableName: document_appointment
              validate: true

          - addForeignKeyConstraint:
              baseColumnNames: document_id
              baseTableName: document_appointment
              constraintName: FK_document_appointment_document_id
              onDelete: NO ACTION
              onUpdate: NO ACTION
              referencedColumnNames: id
              referencedTableName: document
              validate: true

          - addForeignKeyConstraint:
              baseColumnNames: appointment_id
              baseTableName: document_appointment
              constraintName: FK_document_appointment_appointment_id
              onDelete: NO ACTION
              onUpdate: NO ACTION
              referencedColumnNames: id
              referencedTableName: appointment
              validate: true

    - changeSet:
        id: fix-internment-episode-status-administrative-discharge-date-null-1.39
        comment: Corrige bug sobre el estado de internaci√≥n cuando no se tiene alta adminsitrativa.
        author: etrapani
        context: "!schema-only"
        changes:
          - sql:
              sql: |-
                UPDATE internment_episode
                SET status_id = 1
                WHERE id IN (
                  SELECT id
                  FROM internment_episode AS ie
                  LEFT join patient_discharge As pd ON (ie.id = pd.internment_episode_id)
                  WHERE ie.status_id = 2
                  AND pd.administrative_discharge_date is null)